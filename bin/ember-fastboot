#!/usr/bin/env node
'use strict';

/* eslint-env node */
const FastBootAppServer = require('fastboot-app-server');
const ExpressHTTPServer = require('fastboot-app-server/src/express-http-server');
const express = require('express');
const { URL } = require('url');
const FastbootFSCache = require('fastboot-fs-cache');
const cache = new FastbootFSCache();

// Provide a title to the process in `ps`
process.title = 'ember-fastboot-server';

let distPath =  'tmp/deploy-dist';

const serverOptions = {
  port: process.env.PORT ? process.env.PORT : 3000,
  cache,
  distPath,
  gzip: false // Let Fastly take care of compression, reducing load on the fastboot
};

const httpServer = new ExpressHTTPServer(serverOptions);

const { log } = console;
const app = httpServer.app;

app.use(express.static(distPath, {
  setHeaders(res, path, stat) {
    res.setHeader('Cache-Control', 'public, max-age=365000000, immutable');
    res.removeHeader('X-Powered-By');
  }
}));

/** We rewrite the 307 location header into a relativeURL so that our special setup is handled */
app.use(function(req, res, next) {
  const originalSendFn = res.send;

  res.send = function(data) {
    if (res.hasHeader('location')) {
      let originalLocation = res.getHeader('location');

      // FastBoot broke us once by removing the protocol so adding a check for safety
      if (originalLocation.startsWith('//')) {
        originalLocation = `http:${originalLocation}`;
      }

      let relativeURL = '/api/ember/2.14/namespaces/Ember';

      try {
        relativeURL = new URL(originalLocation).pathname;
      } catch (e) {
        log(`Original location value: ${originalLocation}`)
        log(e);
      }

      res.setHeader('location', relativeURL);
      arguments[0] = arguments[0].replace(new RegExp(originalLocation, 'g'), relativeURL);
    }
    originalSendFn.apply(res, arguments);
  }

  res.removeHeader('X-Powered-By');
  next();
});

let server = new FastBootAppServer(Object.assign({ httpServer }, serverOptions));

server.start();
